{% extends 'base.html' %}

{% block title %}Gerenciamento de Usuários{% endblock %}

{% block content %}
<div class="users-page">
    <h2>Gerenciamento de Usuários</h2>
    
    <div class="users-actions">
        <button onclick="openAddUserModal()" class="btn btn-primary">Adicionar Usuário</button>
    </div>

    <table class="users-table">
        <thead>
            <tr>
                <th>Nome de Usuário</th>
                <th>Nome Completo</th>
                <th>E-mail</th>
                <th>Grupo</th>
                <th>Status</th>
                <th>Último Acesso</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td>{{ user.username }}</td>
                <td>{{ user.get_full_name }}</td>
                <td>{{ user.email }}</td>
                <td>{{ user.groups.first.name|default:"-" }}</td>
                <td>{{ user.is_active|yesno:"Ativo,Inativo" }}</td>
                <td>{{ user.last_login|date:"d/m/Y H:i"|default:"-" }}</td>
                <td>
                    <button onclick="editUser({{ user.id }})" class="btn btn-sm">Editar</button>
                    <button onclick="toggleUserStatus({{ user.id }})" class="btn btn-sm">
                        {{ user.is_active|yesno:"Desativar,Ativar" }}
                    </button>
                    <button onclick="resetPassword({{ user.id }})" class="btn btn-sm">Resetar Senha</button>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7">Nenhum usuário encontrado.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal de Usuário -->
<div id="userModal" class="modal" style="display: none;">
    <div class="modal-content">
        <button class="modal-close" onclick="closeModal('userModal')">&times;</button>
        <h3 id="modalTitle">Novo Usuário</h3>
        <form id="userForm" onsubmit="handleUserSubmit(event)">
            {% csrf_token %}
            <div class="form-group">
                <label for="username">Nome de Usuário</label>
                <input type="text" id="username" name="username" required>
            </div>
            <div class="form-group">
                <label for="email">E-mail</label>
                <input type="email" id="email" name="email" required>
            </div>
            <div class="form-group">
                <label for="first_name">Nome</label>
                <input type="text" id="first_name" name="first_name">
            </div>
            <div class="form-group">
                <label for="last_name">Sobrenome</label>
                <input type="text" id="last_name" name="last_name">
            </div>
            <div class="form-group">
                <label for="group">Grupo</label>
                <select id="group" name="group">
                    <option value="">Selecione um grupo</option>
                    {% for group in groups %}
                    <option value="{{ group.id }}">{{ group.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-actions">
                <button type="button" onclick="closeModal('userModal')">Cancelar</button>
                <button type="submit">Salvar</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function openAddUserModal() {
    const modal = document.getElementById('userModal');
    modal.style.display = 'flex';
    document.getElementById('modalTitle').textContent = 'Novo Usuário';
    document.getElementById('userForm').reset();
}

async function editUser(userId) {
    const modal = document.getElementById('userModal');
    modal.style.display = 'flex';
    document.getElementById('modalTitle').textContent = 'Editar Usuário';
    
    try {
        const response = await fetch(`/api/admin/users/${userId}/`);
        const user = await response.json();
        
        document.getElementById('username').value = user.username;
        document.getElementById('email').value = user.email;
        document.getElementById('first_name').value = user.first_name;
        document.getElementById('last_name').value = user.last_name;
        document.getElementById('group').value = user.group_id || '';
        
        const form = document.getElementById('userForm');
        form.dataset.userId = userId;
    } catch (error) {
        showNotification('Erro ao carregar dados do usuário', 'error');
    }
}

async function handleUserSubmit(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const userId = form.dataset.userId;
    
    try {
        const url = userId ? 
            `/api/admin/users/${userId}/` : 
            '/api/admin/users/';
        
        const response = await fetch(url, {
            method: userId ? 'PUT' : 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(Object.fromEntries(formData))
        });
        
        if (response.ok) {
            showNotification('Usuário salvo com sucesso', 'success');
            closeModal('userModal');
            location.reload();
        } else {
            throw new Error('Erro ao salvar usuário');
        }
    } catch (error) {
        showNotification(error.message, 'error');
    }
}

async function toggleUserStatus(userId) {
    try {
        const response = await fetch(`/api/admin/users/${userId}/toggle-status/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        if (response.ok) {
            showNotification('Status do usuário atualizado', 'success');
            location.reload();
        } else {
            throw new Error('Erro ao atualizar status do usuário');
        }
    } catch (error) {
        showNotification(error.message, 'error');
    }
}

async function resetPassword(userId) {
    if (!confirm('Tem certeza que deseja resetar a senha deste usuário?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/admin/users/${userId}/reset-password/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        if (response.ok) {
            const { password } = await response.json();
            alert(`Nova senha: ${password}\nPor favor, compartilhe com o usuário de forma segura.`);
        } else {
            throw new Error('Erro ao resetar senha');
        }
    } catch (error) {
        showNotification(error.message, 'error');
    }
}
</script>
{% endblock %}